(ns me.tonsky.persistent-sorted-set.test.small
  (:require
    [me.tonsky.persistent-sorted-set :as set]
    #?(:clj [me.tonsky.persistent-sorted-set.test-storage :as test-storage])
    #?(:cljs [cljs.test    :as t :refer-macros [is are deftest testing]]
        :clj  [clojure.test :as t :refer        [is are deftest testing]]))
  #?(:clj
      (:import [clojure.lang IReduce])))

#?(:clj (set! *warn-on-reflection* true))

(deftest test-small
  ; (is (= (range 10 20)
  ;       (seq (into (set/sorted-set) (range 10 20)))))
  
  ; (is (= (range 10 20)
  ;       (seq (into (set/sorted-set) (reverse (range 10 20))))))
  
  ; (is (= (range 10 20)
  ;       (seq
  ;         (set/slice
  ;           (into (set/sorted-set) (reverse (range 0 100)))
  ;           10
  ;           19))))
  
  ; (is (= (range 19 9 -1)
  ;       (rseq (into (set/sorted-set) (range 10 20)))))
  
  ; (is (= (range 19 9 -1)
  ;       (set/rslice (into (set/sorted-set) (range 0 40)) 19 10)))
  
  ; (is (= (range 10 20)
  ;       (set/slice (into (set/sorted-set) (range 0 40)) 10 19)))

  ; (let [s (into (set/sorted-set) (shuffle (range 0 5001)))]
  ;   (is (= (set/rslice s 5000 nil)
  ;         (some-> (set/rslice s 5000 nil) rseq reverse))))
)

; (deftest stresstest-rslice
;   (println "  testing stresstest-rslice...")
;   (dotimes [i 1000]
;     (testing (str "Iter: " i "/1000")
;       (let [len   3000
;             xs    (vec (shuffle (range 0 (inc 3000))))
;             s     (into (set/sorted-set) xs)]
;         (try
;           (let [left  (set/rslice s (+ 3000 100) -100)
;                 right (-> (set/rslice s (+ 3000 100) -100) rseq reverse)]
;             (is (= left right)))
;           (catch :default e
;             (println xs)
;             (js/console.log e)))))))

(deftest rslice
  (let [xs [2563 413 7 1924 332 2157 2879 1887 703 973 1849 1693 1674 455 2014 1316 633 2169 2107 1018 2627 2608 2990 2345 2533 1544 344 1308 2745 776 66 225 1331 394 1132 512 543 1766 257 800 773 2876 2458 1527 2791 552 921 2145 888 2736 1876 577 2143 617 2821 2523 2485 174 1323 1047 1250 2660 1310 1396 2962 758 2347 503 400 2924 538 2609 1243 957 1796 1144 2948 275 412 637 2049 978 1078 765 747 1772 1714 2262 2811 1372 2141 844 991 1263 1896 2557 1999 2119 1011 761 788 1934 2703 2118 1687 2921 2472 2641 1628 2664 366 1440 2002 1545 2190 1708 477 1689 2328 385 1812 1758 917 1103 2848 1328 1837 29 1828 2410 1835 2812 2062 2113 2552 168 1213 415 2638 310 1947 2929 2081 99 1592 2413 1351 1750 309 414 947 117 1502 576 2378 2589 1155 2623 1651 1125 2530 1954 1618 542 1603 297 692 2602 863 963 1270 1246 799 2033 623 771 1183 2781 2968 1919 1792 1366 2598 1126 2280 1699 1922 2842 2134 2856 2774 535 429 2957 1602 1675 1361 13 2918 1777 2726 1235 1632 389 1116 935 1345 1055 2386 1967 2404 1593 2076 476 2677 2206 1865 2 372 0 1721 163 1042 1737 2137 2723 2548 2634 2380 1768 1991 317 2591 1827 1751 1558 923 2605 2316 382 752 2681 1446 34 630 2839 57 272 1617 1997 1939 2942 2895 492 1637 281 1524 22 2574 755 859 69 1958 1397 652 1007 2492 4 2746 537 495 308 2177 2041 898 2575 1811 2090 402 1630 1574 1819 2905 91 839 700 2822 74 2840 1445 2222 862 1741 2136 812 1026 527 47 2230 2061 578 2384 600 1854 2366 2527 2321 585 2935 320 575 2372 2762 641 1734 2828 2793 2674 1170 1172 1988 2344 824 1624 1634 2897 1491 2131 185 2317 78 1576 924 2334 19 147 128 2332 1095 2454 1691 2695 2654 270 1557 2713 2252 2645 1344 1834 116 2684 24 1319 2205 2008 211 1367 2992 2001 1989 522 1015 988 1685 2804 2265 1597 1187 1915 403 1052 1791 581 497 2694 121 2749 187 207 2525 1198 1855 2255 2538 730 713 302 748 6 2239 2040 1101 1798 968 2035 2931 1512 980 280 299 1110 169 1929 1528 674 669 1088 2241 1644 2873 273 2299 2615 318 1774 2835 1291 2778 2950 2534 197 598 854 1959 792 2075 2295 2936 1717 738 1181 1073 2484 731 569 1906 88 351 2594 456 928 2294 1500 364 586 1805 2633 2859 1050 1881 1106 1995 875 264 2759 2450 1436 2220 2466 1060 371 1955 380 1033 1942 1904 2279 2318 737 1084 221 2412 1239 28 291 849 1860 936 757 1573 648 1462 220 125 2300 123 1762 224 496 2517 2904 2510 1420 1302 787 1863 1873 1182 1910 2112 2675 2872 18 1451 510 2760 1987 1256 2420 1975 1658 165 202 1877 159 679 1836 1398 399 41 1414 1710 2972 1339 263 1802 2238 2341 1575 2015 2765 331 549 1255 268 1342 42 722 1269 164 61 323 1475 2562 2351 2754 860 1437 639 266 687 475 1236 1330 269 857 2637 1191 1162 2447 2676 937 1829 2571 1334 1266 501 744 948 716 676 2162 2969 665 2543 2436 2159 1847 1135 1379 1337 2658 1725 44 959 2495 2863 2055 2288 2192 2692 2314 2434 2158 2719 1886 1064 2092 2439 2680 1928 675 1173 27 2155 646 204 1041 2629 2039 1014 1846 1895 2528 314 1570 326 847 712 1154 1341 2952 1869 1020 774 2269 1655 1930 1842 1409 1523 1926 2207 2544 2930 624 1139 504 194 605 1071 290 2794 2819 481 102 943 2390 1085 1664 2359 148 2567 390 1539 212 2234 486 2111 760 2687 1482 1444 1114 2212 1259 2849 1082 499 1340 1313 2653 2109 1169 2026 714 1654 2838 292 1871 1543 223 446 1061 1923 2914 1672 1966 1200 1701 2007 2730 1140 2971 521 1218 2988 1184 324 953 2668 279 2286 282 1875 816 1688 2697 1893 1129 2173 2278 1128 942 2116 2833 68 1093 2355 1944 927 1547 721 1695 2832 2995 582 1843 932 1788 640 837 1383 2096 533 2260 594 1510 337 2617 1972 525 1569 1177 49 829 2195 1438 604 2326 724 2470 1680 2640 2246 253 2769 1176 209 2728 912 1381 2504 1913 1326 831 2880 435 2050 1585 2167 1608 1522 2088 2298 2734 820 293 1421 1148 2743 1551 215 2738 1350 2783 2272 2469 931 2568 2210 470 485 1426 2037 631 2142 1209 1640 1165 377 2735 818 1427 2649 984 2761 2983 2913 2247 1920 565 817 1607 664 2597 954 996 2635 11 1562 1914 65 626 2244 1074 708 2385 2560 2438 2228 601 2125 2722 1520 1365 2982 2012 2174 2197 1261 2089 657 95 1661 986 2482 1028 1016 2711 611 423 1861 597 407 520 2998 1004 1333 67 2717 238 153 1153 108 5 327 2502 661 882 1216 2084 127 2179 458 2445 949 1032 1629 1909 2999 2101 941 85 1188 2229 1616 838 693 1848 151 1195 1704 2408 2984 2406 596 566 1441 50 1355 216 1099 843 1072 1584 233 56 2678 1349 1412 441 1568 655 1425 2875 2945 1678 1613 2978 2550 907 2032 141 899 797 1329 2340 2696 1434 479 2080 1242 2483 2870 1146 2727 229 2349 2496 1760 1671 2979 2747 35 505 2775 2934 786 865 430 1511 2045 701 666 530 2497 2151 1853 1168 2701 2565 2455 2311 1684 2561 1294 2017 2855 813 2130 1719 780 1885 2847 2686 694 1019 2403 347 1034 2467 1257 1325 2800 411 2583 115 393 191 591 1091 1244 1 562 1660 1134 2082 753 1764 1673 1635 1878 2661 2976 1224 376 358 1970 583 1210 1348 2315 1720 961 474 1748 2024 929 2724 460 2755 2868 934 1119 871 2626 2254 2882 2853 981 649 1474 186 2395 157 2371 1694 1610 2796 1890 897 2226 2646 1565 362 81 1289 808 2354 2975 620 1596 2353 2236 718 2901 1946 1783 909 2460 2584 2180 1752 2182 2596 2917 2767 2078 267 2446 265 2237 1883 2923 2393 1051 203 1278 1948 94 482 1587 1838 2214 1485 90 1035 2655 814 1189 835 2960 2291 690 1852 1984 1130 419 629 1027 955 1504 2383 2149 1070 607 1940 790 1096 1192 301 247 183 2401 2387 1221 311 1083 746 1399 524 2391 1880 528 2150 519 92 1090 994 1729 2542 2435 1874 213 112 171 1025 2636 1417 428 2430 1649 406 1514 2909 2301 962 1839 1795 1866 1301 2886 2422 2098 1299 2776 2946 1439 2770 1499 544 663 487 1003 895 109 1219 2893 2665 2657 1894 2564 726 395 104 2437 1698 2011 1104 110 328 2522 1429 1358 852 1912 162 1247 2902 106 2705 2095 2077 1203 2284 1463 1212 1538 2889 802 751 2010 2733 2147 710 2878 2054 489 763 1542 848 775 1178 2407 2806 1535 2792 745 1454 1601 1037 1017 944 1432 2766 891 2168 422 2817 1965 53 736 2094 2451 2547 142 2814 432 134 2718 383 1112 305 135 985 2826 1354 1806 1513 1900 1595 740 2128 1529 2643 2274 1138 2885 2256 1778 1473 970 304 2427 1830 580 321 2973 1370 514 2742 80 2881 782 2297 63 2887 1303 739 2069 2421 2691 1807 1581 795 2242 2282 1265 741 172 306 1124 37 2249 2373 1957 832 1391 743 1252 845 2044 1823 647 1960 595 656 1202 2240 1746 2515 1343 2065 271 1005 1589 156 1122 809 1594 1690 563 16 1911 933 1097 2704 734 2748 1282 158 777 727 450 1225 2706 2786 179 23 356 2479 2780 1889 1254 12 1702 885 966 2486 1956 1683 1297 1092 449 467 138 1452 2424 603 902 166 2027 616 2289 240 2797 2941 1295 2829 2464 1002 1707 1556 1407 9 2216 1770 2825 798 1951 1882 2028 682 333 1818 190 1197 1371 1903 2836 1483 1336 684 1775 2122 2259 881 2989 840 811 572 1639 1739 2452 2647 2307 387 2512 1363 1347 1258 2360 401 59 1443 791 806 2787 426 1526 1281 1456 2916 1841 2511 993 2865 1686 1309 1925 1053 850 733 1507 606 1274 2038 249 1626 2463 2031 145 1304 409 2740 2365 1158 39 354 1722 1123 725 1973 2218 1560 322 2816 553 2949 2431 925 2346 2029 769 184 1495 2477 2611 1161 678 1100 2967 784 192 2721 516 2739 2698 2021 1803 336 1815 698 2642 2850 588 2846 1179 1765 1481 1253 1067 2051 1901 2954 500 599 1563 1622 2085 612 1141 1405 2756 990 1360 2442 1214 1814 1745 1800 2595 2907 2862 1884 1606 2201 1467 1150 759 1346 1534 707 2841 1992 2292 926 1241 2576 2474 45 448 1392 457 903 2864 2970 2966 1143 1094 2607 1953 874 1306 1633 1410 1667 1423 2369 404 1986 1312 2891 1277 2784 1740 464 2509 2753 2309 574 717 1747 98 2217 1232 564 2323 1160 1840 2325 1821 1133 1470 2566 2933 2330 218 1598 2579 2554 2060 2196 2689 2546 436 355 437 2047 2331 946 2994 397 1352 1386 26 1163 589 1079 1850 916 2322 122 952 3000 1943 2618 2389 2688 243 2184 1964 1730 1031 2398 214 735 627 2370 2059 2588 1638 2662 1743 2939 161 1107 1787 2808 1586 2342 1712 1728 2614 2042 2928 1044 2545 619 1786 545 2708 259 1021 386 2813 2043 1820 1145 228 239 1554 2779 2628 1008 1248 628 1969 242 1049 997 2170 1945 1012 2267 2068 1023 227 2357 338 508 1578 974 2480 2250 2860 2444 1075 1152 2073 2632 373 410 466 1369 2276 1541 2296 662 2785 1647 1521 705 1856 346 939 2114 254 1816 2034 1950 119 84 547 1724 1227 826 252 1982 2319 1395 2593 14 150 1009 2621 821 2539 502 408 1156 2356 2013 2253 2715 789 1416 1469 1380 754 427 480 83 1935 1666 2729 2133 2866 2959 1484 2056 1771 370 343 1981 1665 1332 1656 560 1048 2540 867 889 1615 1457 1166 1237 200 2854 2108 2852 567 140 1755 1659 1115 226 40 1738 2100 1705 1994 2191 659 1931 2153 920 2091 420 1320 1180 1476 1109 1785 1205 51 329 1692 2103 2343 1390 431 1742 2861 87 2476 1279 1879 1296 2003 2488 126 1498 511 1404 1460 2996 965 1784 2644 1709 201 766 195 193 2261 868 77 1419 1530 1222 2178 2956 1998 1455 1789 444 2433 2751 2650 100 1442 2986 1669 796 890 1063 958 1411 1186 723 1069 892 155 1190 38 691 2663 2810 2160 2702 886 296 610 807 621 298 2732 1385 526 1501 2912 2443 2659 2837 2922 196 2097 1763 1433 206 188 1813 1201 208 2233 1057 1648 869 2499 379 2669 2651 1727 877 2803 2900 1389 21 2473 2487 1857 1780 1735 113 2333 2067 2440 1321 283 1757 1220 2580 1120 1902 2507 864 1494 1062 2193 822 342 2549 260 2685 1636 794 1793 825 1916 392 650 1431 1713 246 1466 2915 1517 2884 1171 1362 198 1479 1851 2245 1046 1506 2176 25 2963 1450 1394 30 2622 2506 2144 2559 2631 987 2938 1207 2268 644 671 1217 1024 289 2531 2896 2302 571 378 554 1406 1359 815 1068 2213 2018 1990 2419 440 498 2093 1388 1157 1804 2258 2166 1891 922 855 491 2601 2906 805 2553 1065 2198 992 2126 1430 2519 353 2000 969 32 2714 1324 1826 1824 2801 2377 2606 388 1118 532 1054 2690 210 2102 2232 1418 2304 1917 439 62 2382 911 405 445 1087 136 654 107 120 2235 1415 2402 1403 454 1251 1488 2361 2940 2535 2132 2071 1435 749 2161 1936 352 15 2181 2845 178 284 1643 130 2070 2052 1102 1400 507 1907 2712 2211 1276 1211 46 1036 1561 2750 1533 1284 1706 335 137 982 1174 2894 33 36 2063 546 779 2789 975 2805 2799 319 2831 1604 1645 989 10 278 245 2189 2619 1536 381 2275 1952 1619 2064 559 71 2022 517 105 614 277 2339 2313 872 2005 1262 124 2405 494 2266 1287 2532 2585 144 2489 1393 237 1108 2432 1149 2030 1996 2231 2215 2478 536 1264 1515 2951 834 1477 732 1537 853 465 2264 2823 2892 1600 573 236 836 1932 830 2019 2164 1193 438 680 2394 2209 2581 312 463 1422 1151 704 180 1428 1314 398 964 468 2874 1478 592 625 906 1458 896 1374 548 350 2375 114 1077 2099 1286 433 696 1461 146 570 772 129 2457 1000 828 1782 638 673 1918 2293 1682 2572 1663 1711 915 1870 1794 2471 2985 509 2310 2418 642 82 2121 2172 2362 1489 568 2616 767 340 998 1111 1799 1767 43 823 550 1652 1516 1194 1136 2194 742 879 683 2053 1518 2336 1731 2277 945 2257 2834 2338 1280 632 2156 443 58 1378 2683 1844 2777 894 2223 1621 1859 967 1402 1696 391 1305 1937 2505 1625 1700 232 1121 2699 2185 1978 64 1081 1941 1754 1519 2124 2417 2503 251 2888 622 1781 72 2877 2599 2555 1508 1006 2795 1676 518 2490 2129 976 1311 2592 893 1318 668 651 152 1797 2693 842 1715 1167 1472 2824 1408 52 1864 697 1525 75 2106 1697 1779 2514 286 883 1215 804 1298 417 2656 2465 1043 706 1550 685 199 2648 234 1756 677 2183 1985 205 699 1549 878 2290 900 715 60 2305 2327 2997 2494 686 2329 1963 539 2397 1888 1098 1142 334 1376 2079 255 2117 2798 1240 2324 1579 2851 901 2788 579 1137 1029 2903 2570 1759 709 2556 1808 904 2569 913 711 1204 2139 70 1315 873 1487 658 1614 1898 977 2358 1292 2744 2415 2670 866 1646 2048 1897 1056 615 1013 2624 672 2083 2707 2086 1505 2529 2815 908 1300 1681 960 1208 1822 2414 2020 418 950 1921 262 2541 2016 2899 972 2926 1867 1599 861 2731 1268 2741 2987 453 1271 1249 1552 2516 2513 1368 1401 1620 2379 1858 111 1670 1773 276 2468 914 1546 1657 2508 1726 2604 2104 2350 1961 2058 2203 484 131 2449 670 2074 1831 472 1275 149 1933 1776 783 2955 756 870 1983 250 1283 2932 2612 2423 1662 170 2782 451 313 1127 1231 2152 459 2448 534 2908 2348 2188 421 1492 1375 2287 2224 1744 1357 1377 1564 2057 2374 1790 555 2429 118 348 1468 3 1736 983 241 1976 1832 540 2974 1066 2620 307 1001 2281 2867 316 1459 803 2462 288 2590 471 1703 1293 858 1611 1040 2271 2964 2186 1226 702 1228 2927 2630 248 2700 1364 1949 330 1845 2498 2844 375 2004 2154 182 2578 2066 1233 2809 176 2790 1164 2943 1653 841 1089 461 1571 424 1509 2521 473 1273 2869 2120 1627 1196 1117 2219 1862 2679 1559 1490 139 506 1938 951 1229 359 819 2536 2958 2204 2399 2227 1580 1532 688 602 2491 315 2175 2320 2551 2937 919 1327 529 1609 2898 2165 442 54 478 1356 2046 1453 1810 2981 357 2993 1668 1905 635 2858 300 1424 515 1723 995 2610 2221 918 1322 2392 810 695 1679 48 1317 1591 2672 856 513 341 2625 2586 96 1732 2980 2666 2577 1872 2827 681 2110 1238 1338 720 2138 261 490 1131 768 447 609 2202 101 608 880 1566 2716 1105 2306 2526 2587 2009 2573 143 1038 2171 1449 1977 653 2087 2283 1384 1801 349 2639 2673 2072 801 1471 643 2367 750 833 2140 999 217 2459 294 483 938 2025 2725 452 2425 1058 728 531 1868 1465 2312 1147 2308 2500 2416 1245 425 2303 1927 2481 1833 887 689 86 1159 2603 2737 493 303 2757 258 2376 541 1113 2148 1272 365 219 374 1199 1583 2105 160 1531 73 2773 2493 729 1555 1641 2910 1387 558 2843 2890 2163 1022 167 2337 1290 1718 2520 2709 2919 2961 1267 97 55 2965 1076 2426 2911 175 2411 469 1039 8 222 287 1353 1817 1761 368 971 1716 905 2115 1769 2270 2558 793 979 2453 762 587 930 645 1968 1373 2023 634 1285 274 235 1223 295 2752 2991 325 2818 181 1553 1825 2368 462 523 770 2146 1206 2396 2857 1059 1307 2953 590 1185 584 1962 2501 2600 2977 2682 384 76 1993 667 2820 2871 2944 764 1230 1496 2920 636 2381 2243 1486 2883 956 1892 1464 785 557 2720 1234 2248 1447 256 593 2582 1980 244 827 2123 1677 1582 2273 1382 1642 434 2363 556 2251 1650 1548 2537 2652 719 2200 551 1335 2263 2807 173 2771 2461 2710 1497 1480 2524 910 940 1612 1540 2925 1974 1175 1010 345 230 1572 89 231 2830 133 2802 363 361 1493 846 2285 17 154 1503 1030 79 851 2667 660 1899 613 1260 103 2613 2947 1588 1623 93 1590 189 1809 1979 177 1971 561 2187 1288 31 1605 2352 2758 2335 2006 1733 2199 2135 876 2409 1577 2225 1749 488 1567 884 618 1086 2127 396 1448 132 416 2388 360 2456 2036 781 2400 20 1045 2768 2763 2475 2772 2671 1080 2428 339 2764 1413 1631 2364 778 1753 2208 285 369 2441 2518 1908 367]]
    (try
      #_(println (-> (into (set/sorted-set) xs)
                 (set/rslice 3000 -100)))
      (catch :default e
        (js/console.log e)))))